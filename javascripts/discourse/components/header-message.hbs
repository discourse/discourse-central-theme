{{#if currentUser}}

  <ul
    class={{concatClass
      "header-message__submenu"
      (unless this.submenuIsActive "hidden")
    }}
    style={{concatStyle}}
  >
    <li>
      <a href={{concat "/u/" currentUser.username "/messages"}}>
        {{d-icon "m-inbox"}}
        <span>Go to inbox</span>
      </a>
    </li>
    <li>
      <a href {{on "click" this.toggleMoveToHeader}}>
        {{d-icon "m-call_received"}}
        <span>Move to sidebar</span>
      </a>
    </li>
  </ul>

  <button
    class={{concatClass
      "header-message__button"
      (if isActive "active")
      (unless this.isMovedToHeader "hidden")
    }}
    type="button"
    {{on "click" this.toggleDropdown}}
  >
    {{d-icon "m-mail"}}
    {{#unless (eq allUnread 0)}}
      <span class="notification-count">
        {{allUnread}}
      </span>
    {{/unless}}
  </button>

  <div
    class={{concatClass
      "header-message__menu"
      (unless this.isMovedToHeader "hidden")
    }}
  >
    <div class="header-message__heading">
      <a href={{concat "/u/" currentUser.username "/messages"}}>
        <h3>
          Messages
        </h3>
      </a>
      <ul class="header-message__buttons">
        <li>
          <a
            href
            {{on "click" this.toggleSubmenu}}
            class={{concatClass
              "header-message__more"
              (if this.submenuIsActive "active")
            }}
          >
            {{d-icon "m-more_horiz"}}
          </a>
        </li>
        <li>
          <a href="/new-message">
            {{d-icon "m-post_add"}}
          </a>
        </li>
      </ul>
    </div>

    {{#unless (eq inboxes.length 1)}}
      <ul class="header-message__inboxes">
        {{#each inboxes as |inbox index|}}
          <li class="header-message__inbox">
            <button
              class={{if (eq index selectedTabIndex) "active"}}
              disabled={{loading}}
              type="button"
              {{action selectTab index}}
            >
              {{#if inbox.full_name}}
                {{inbox.full_name}}
              {{else}}
                {{inbox.name}}
              {{/if}}
            </button>
            {{#unless (eq inbox.unread_total 0)}}
              <span class="notification-count">
                {{inbox.unread_total}}
              </span>
            {{/unless}}
          </li>
        {{/each}}

      </ul>
    {{/unless}}
    {{#if loading}}
      {{loading-spinner}}
    {{else}}
      <ul class="header-message__messages">
        {{#each messages.topic_list.topics as |message|}}
          <li>
            <a
              href={{concat
                "/t/"
                message.slug
                "/"
                message.id
                "/"
                message.highest_post_number
              }}
            >
              <div class="header-message__avatar">
                {{bound-avatar-template
                  message.first_poster.avatar_template
                  "large"
                }}
                {{#unless message.no_replies}}
                  {{bound-avatar-template
                    message.last_poster.avatar_template
                    "large"
                  }}
                {{/unless}}
              </div>
              <div class="header-message__info">
                <div class="header-message__info-top">
                  <span class="header-message__name">
                    {{#if (get message.posters "0.name")}}
                      {{get message.posters "0.name"}}
                    {{else}}
                      {{get message.posters "0.username"}}
                    {{/if}}
                  </span>
                  <span
                    class={{concatClass
                      "header-message__date"
                      (unless (eq message.unread 0) "unread")
                    }}
                  >
                    {{format-date message.last_posted_at format="tiny"}}
                  </span>
                </div>
                <span class="header-message__title">
                  {{message.title}}
                </span>
                <p class="header-message__excerpt">
                  {{message.excerpt}}
                </p>
                {{#if message.tags}}
                  <ul class="header-message__tags">
                    {{#each message.tags as |tag|}}
                      <li>
                        {{tag}}
                      </li>
                    {{/each}}
                  </ul>
                {{/if}}

                <div
                  class={{concatClass
                    "header-message__assigned"
                    (if message.assigned_to_user "direct")
                    (if message.indirectly_assigned_to "indirect")
                  }}
                >
                  {{d-icon "m-person_add_alt"}}
                  <ul>
                    {{#if message.assigned_to_user}}
                      <li>{{message.assigned_to_user.username}}</li>
                    {{/if}}

                    {{#if message.indirectly_assigned_to}}
                      {{#each
                        (objectToArray message.indirectly_assigned_to)
                        as |assignee|
                      }}
                        <li>{{assignee.assigned_to.username}}</li>
                      {{/each}}
                    {{/if}}
                  </ul>
                </div>

              </div>
            </a>
          </li>
        {{/each}}
      </ul>
    {{/if}}
  </div>
{{/if}}